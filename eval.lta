(lt64-asm-mod

(proc eval/form
    :first :push eval/atom? :call
      :push eval-form-atom :branch
    ;; else is list (for now)
    :push eval/apply :call
    :ret

:label eval-form-atom
    ;; just "return" the atom
    :ret)

;; Take an address and check if it is atom
(proc  eval/atom?
       :first :!sym/symbol?
         :second :!number/int?
         :or :second :!number/fixed?
         :or
       :swap :pop
       :ret)

;; Takes an address of a pair and applies the car as a function on the cdr
;; Leaves the result's address.
(proc  eval/apply
       :first :!pair/car
       :first :!QUOTE :eq
         :push eval-apply-quote :branch
       :first :!CAR :eq
         :push eval-apply-car :branch
       :first :!CDR :eq
         :push eval-apply-cdr :branch
       :first :!CONS :eq
         :push eval-apply-cons :branch
       :first :!ATOM? :eq
         :push eval-apply-atom? :branch
       :!NIL ;; for now so all lists must be quoted to not be evalled
       :ret

:label eval-apply-quote
       :pop
       :!pair/cdr :!pair/car
       :ret
:label eval-apply-car
       :pop
       :push eval/pair-car :call
       :ret
:label eval-apply-cdr
       :pop
       :push eval/pair-cdr :call
       :ret
:label eval-apply-cons
       :pop
       :push eval/pair-cons :call
       :ret
:label eval-apply-atom?
       :pop
       :push eval/apply-atom? :call
       :ret
)

(proc  eval/first-arg
       :!pair/cdr :!pair/car
       :push eval/form :call
       :ret
)

(proc  eval/second-arg
       :!pair/cdr :!pair/cdr :!pair/car
       :push eval/form :call
       :ret
)


(proc  eval/pair-car
       :push eval/first-arg :call
       :first :push eval/atom? :call
         :push eval-pair-car-nil :branch
       :!pair/car
       :ret
:label eval-pair-car-nil
       :pop :!NIL :ret
)

(proc  eval/pair-cdr
       :push eval/first-arg :call
       :first :push eval/atom? :call
         :push eval-pair-cdr-nil :branch
       :!pair/cdr
       :ret
:label eval-pair-cdr-nil
       :pop :!NIL :ret
)

(proc  eval/pair-cons
       :first :push eval/first-arg :call
       :second :push eval/second-arg :call
       :rot :pop

       :push alloc/new-pair :call
       :second :push eval/atom? :call
         :push eval-pair-cons-dotted :branch
       :push pair/make :call
       :push eval-pair-cons-finish :jump
:label eval-pair-cons-dotted
       :push pair/make-dotted :call
       ;; fallthrough
:label eval-pair-cons-finish
       :rot :second :!pair/set-car
       :swap :second :!pair/set-cdr
       :ret
)

(proc  eval/apply-atom?
       :push eval/first-arg :call
       :push eval/atom? :call
         :push eval-apply-atom?-true :branch
       :!F :ret
:label eval-apply-atom?-true
       :!T :ret
)

)

